<% primary_color = (interview.project.primary_color || DEFAULT_PRIMARY_COLOR).sub('#', '') %>
\definecolor{primaryColor}{HTML}{<%= primary_color %>}

<%
  rtl = ["ara", "heb"].include?(content_locale.to_s)
  interviewee_name = interview.interviewee.display_name

  title = [
    tv("#{doc_type}_title", header_locale, lang: content_locale_human),
    interviewee_name
  ].join(" ")

  header_text = [
    tv("#{doc_type}_header", header_locale, lang: content_locale_human),
    interviewee_name,
    "(#{tv('archive_id', header_locale)} #{interview.archive_id})"
  ].join(" ")

  tape = 0
  speaker_id = nil
%>

\title{<%= title %>}

\begin{document}

<%=
  render partial: "latex/header_footer",
    locals: {
      header_text: header_text,
      interview: interview,
      header_locale: header_locale,
      doc_type: doc_type
  }
%>

<%=
  render partial: "latex/title",
    locals: {
      title: title,
      space_above: 3,
      space_below: 3,
      font_size: 18
  }
%>

<%=
  render partial: "latex/info",
    locals: {
      interview: interview,
      header_locale: header_locale,
      doc_type: doc_type
  }
%>

\newpage

<%# set section fontsize: %>
\titleformat{\section}
  {\normalfont\fontsize{11}{13}\bfseries}{\thesection}{1em}{}
\titleformat{\subsection}
  {\normalfont\fontsize{10}{12}\bfseries}{\thesubsection}{1em}{}

<%# set title of  tableofcontents: %>
<% if headings_in_content_locale %>
  \renewcommand{\contentsname}{<%= tv('table_of_contents', header_locale) %>}
  \tableofcontents
<% end %>

\newpage

<% if interview.project.show_legend %>
  <%=
    render partial: "latex/legend",
      locals: {
        header_locale: header_locale,
        interview: interview
    }
  %>
<% end %>

\newpage

<%= render partial: "latex/title",
  locals: {
    title: title,
    space_above: 0,
    space_below: 0.01,
    font_size: 13
  }
%>

<% interview.tapes.each do |tape| %>
  <% tape.segments.includes(:translations).each do |segment| %>

    <% if !segment.mainheading(content_locale_public).blank? %>
      \section{<%= latex_escape(segment.mainheading(content_locale_public)) %>}
      <% if tape != segment.tape.number %>
        <%= render partial: "latex/title",
          locals: {
            title: "#{tv('tape', header_locale)} #{segment.tape.number}",
            space_above: 0.7,
            space_below: 0.05,
            font_size: 10
          }
        %>
      <% end %>

      <%= render partial: "latex/title",
        locals: {
          title: Timecode.new(segment.timecode).timecode[0..7],
          space_above: 0.4,
          space_below: 0,
          font_size: 10
        }
      %>
    <% end %>

    <% if !segment.subheading(content_locale_public).blank? %>
      \subsection{<%= latex_escape(segment.subheading(content_locale_public)) %>}
      <%= render partial: "latex/title",
        locals: {
          title: Timecode.new(segment.timecode).timecode[0..7],
          space_above: 0.4,
          space_below: 0,
          font_size: 10
        }
      %>
    <% end %>

    <%
      text = segment.text(content_locale_public)
      if text.blank?
        next
      end
    %>

    <% if rtl %>
      \begin{flushright}
    <% end %>

    <%
      if segment.speaking_person.nil?
        rtl_speaker = ''
        ltr_speaker = ''
      else
        speaker = latex_escape(segment.speaking_person.name[header_locale.to_sym])
        rtl_speaker = rtl ? " :#{speaker}" : ''
        ltr_speaker = rtl ? '' : "#{speaker}: "
      end
    %>

    <% text = segment.text(content_locale_public) %>
    <% if text.match?(/\p{Hebrew}/) %>
      \texthebrew{<%= latex_escape(text) %>} \textit{<%= rtl_speaker %>}
    <% elsif text.match?(/\p{Arabic}/) %>
      \textarabic{<%= latex_escape(text) %>} \textit{<%= rtl_speaker %>}
    <% elsif text.match?(/\p{Tamil}/) %>
      \textit{<%= ltr_speaker %>} \texttamil{<%= latex_escape(text) %>} \textit{<%= rtl_speaker %>}
    <% else %>
      \textit{<%= ltr_speaker %>} <%= latex_escape(text) %> \textit{<%= rtl_speaker %>}
    <% end %>

    <% if rtl %>
      \end{flushright}
    <% end %>

  <% end %>
<% end %>
